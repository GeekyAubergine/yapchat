<div id="chat_panel">
  <div
    id="chat_message_list_ws"
    hx-ext="ws"
    ws-connect="/ws/{{ user_uuid }}"
  ></div>
  {% include "chat/chat_messages_list.html" %} {% include
  "chat/chat_message_input.html" %}

  <script>
    const record = document.querySelector(".record");
    const stop = document.querySelector(".stop");

    let audioChunks = [];

    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      console.log("getUserMedia supported.");
      navigator.mediaDevices
        .getUserMedia(
          // constraints - only audio needed for this app
          {
            audio: true,
          }
        )

        // Success callback
        .then((stream) => {
          const mediaRecorder = new MediaRecorder(stream);

          record.onclick = () => {
            audioChunks = [];
            mediaRecorder.start();
            console.log(mediaRecorder.state);
            console.log("recorder started");
            record.style.background = "red";
            record.style.color = "black";
          };

          stop.onclick = () => {
            mediaRecorder.stop();
            console.log(mediaRecorder.state);
            console.log("recorder stopped");
            record.style.background = "";
            record.style.color = "";
          };

          mediaRecorder.ondataavailable = (e) => {
            audioChunks.push(e.data);
          };

          mediaRecorder.onstop = async (e) => {
            console.log("recorder stopped");

            const audioBlob = new Blob(audioChunks, { type: "audio/wav" });
            const audioArrayBuffer = await audioBlob.arrayBuffer();

            const uint8Array = new Uint8Array(audioArrayBuffer);
            const audioDataArray = Array.from(uint8Array);

            // Upload
            const formData = new FormData();
            formData.append("audio", audioBlob, "audio.wav");
            fetch("/api/chats/{{ chat_uuid }}/audio", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                audio: audioDataArray,
              }),
            });
          };
        })

        // Error callback
        .catch((err) => {
          console.error(`The following getUserMedia error occurred: ${err}`);
        });
    } else {
      console.log("getUserMedia not supported on your browser!");
    }
  </script>
</div>
